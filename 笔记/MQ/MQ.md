# 注意事项

消费mq是否可能超时

是否可能抛异常

用不用配置重试次数

是否具备幂等性

# 重试队列

消息队列中消费失败的消息会进入重试队列中

# 消息积压

两种情况会导致消息积压

1. 消费方消费消息出现异常, 导致消息重试, 出现积压
2. 消费者连接数为0

# 重试消息

1. 消费方抛出异常
2. 消息消费超时

# 队列数

当客户端进程数>主题拥有的broker数*主题队列数时，客户端并发量就会受限

单个队列中消息是顺序消费，多个队列之间消息消费是无序的

# 批量消费

jmq默认就是批量消费，一次消费10条，消费过程如下：

1. 客户端线程选择一个没有被加锁的队列，从队列中拉取10条消息，不够10条就拉所有的消息
2. 服务端将队列上锁，保证队列中的消息是先进先出的
3. 客户端消费一条消息后发送ack确认，10条消息消费完成后服务端解锁队列
4. 客户端可以继续向后消费消息

# 并行消费

开启并行消费后，队列是否上锁由最大并行数控制

如何理解最大并行数？首先要知道服务端队列中有两种消息，一种已经收到ack确认的消息，一种还没有收到ack确认的消息，最大并行数其实就是队列允许出现没有收到ack消息的最大数量。例如队列的最大并行数是20，现在已经推送了20条消息给客户端，收到了5条ack确认，没有收到ack确认的消息有15条，还没有超出20条，此时服务端队列就会继续想客户端推送5条消息

# 服务端最大出队能力

![image-20211114133520273](/Users/liqian477/Library/Application Support/typora-user-images/image-20211114133520273.png)

调整单次拉取批量条数往往无法影响服务端的出队能力

如果需要降低消费速度可以尝试减小客户端线程数和服务端的队列数（修改队列数是需要审批的）















